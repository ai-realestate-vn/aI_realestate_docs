## ğŸ§  Workflow Chá»©c nÄƒng 1.1 â€“ NLU

### ğŸ¯ Má»¥c tiÃªu & I/O

**Má»¥c tiÃªu:** Nháº­n cÃ¢u ngÆ°á»i dÃ¹ng â†’ xÃ¡c Ä‘á»‹nh Intent + trÃ­ch xuáº¥t Entities/Slots + Æ°á»›c lÆ°á»£ng Confidence.  
**Input:** CÃ¢u ngÆ°á»i dÃ¹ng (tiáº¿ng Viá»‡t, cÃ³ thá»ƒ láº«n Anh/viáº¿t táº¯t/emoji).  
**Output:** `{intent, slots, language, normalized_text, confidence, errors?}`

---

### ğŸš¦ Luá»“ng runtime (Inference) â€“ tá»«ng bÆ°á»›c

#### **1. Preprocess**

- Detect language (vi, en, vi+en), chuáº©n hoÃ¡ Unicode (NFC).
- Lower-case cÃ³ kiá»ƒm soÃ¡t, tÃ¡ch sá»‘/Ä‘Æ¡n vá»‹ ("3 tá»·", "2.5 ty", "3000usd").
- Bá» emoji náº¿u cáº§n.
- Chuáº©n hoÃ¡ chÃ­nh táº£ thÆ°á»ng gáº·p ("q7" â†’ "quáº­n 7", "hn" â†’ "hÃ  ná»™i").

#### **2. Tokenizer & Feature**

- Tokenize theo subword (PhoBERT/ViBERT).
- ThÃªm Ä‘áº·c trÆ°ng regex/gazetteer (quáº­n/huyá»‡n, loáº¡i BÄS, Ä‘Æ¡n vá»‹ tiá»n).

#### **3. Intent Classification**

- MÃ´ hÃ¬nh phÃ¢n lá»›p intent (LLM zero-shot/few-shot hoáº·c fine-tuned transformer nháº¹).
- Top-k intents + xÃ¡c suáº¥t.  
  **VÃ­ dá»¥:** `chao_hoi`, `tim_bds`, `hoi_gia`, `dat_lich_xem`, `tu_van_vay`, `ket_thuc`, `smalltalk`, `khong_hieu`.

#### **4. Entity/Slot Extraction**

- NER/Slot filling (sequence labeling hoáº·c LLM extraction) + regex/gazetteer háº­u kiá»ƒm.
- **Slots gá»£i Ã½ cho BÄS:**
  - `loai_bds`, `khu_vuc`, `ngan_sach`, `so_phong`, `dien_tich`, `huong_nha`, `du_an`, `thoi_gian`, `phuong_thuc`.

#### **5. Normalization**

- `ngan_sach`: â€œ<3 tá»·â€ â†’ `{max: 3e9, currency: VND}`.
- `khu_vuc`: map alias â†’ mÃ£ hÃ nh chÃ­nh chuáº©n.
- `dien_tich`: â€œ70m2â€ â†’ 70.
- `huong_nha`: chuáº©n hoÃ¡ vá» bá»™ `{ÄÃ´ng, TÃ¢y, Nam, Báº¯c, ÄN, TN, ÄB, TB}`.

#### **6. Confidence & Fallback**

```
confidence = w1*P(intent) + w2*avg(P(slot)) - penalties(ambiguous, OOD)
```

- â‰¥ 0.75: cháº¥p nháº­n.
- 0.5â€“0.75: há»i bá»• sung.
- < 0.5: fallback sang `khong_hieu`.

#### **7. Context Merge**

- Há»£p nháº¥t vá»›i bá»™ nhá»› ngáº¯n háº¡n (vÃ­ dá»¥: thá»«a káº¿ `khu_vuc` tá»« cÃ¢u trÆ°á»›c).

#### **8. Output Contract**

```json
{
  "intent": "tim_bds",
  "slots": {
    "khu_vuc": "quáº­n 7",
    "ngan_sach_max": 3000000000,
    "loai_bds": "chung cÆ°",
    "so_phong": 2
  },
  "language": "vi",
  "normalized_text": "tÃ¬m chung cÆ° 2 phÃ²ng ngá»§ á»Ÿ quáº­n 7 dÆ°á»›i 3 tá»·",
  "confidence": 0.82,
  "missing_slots": []
}
```

---

### ğŸ—ï¸ Workflow huáº¥n luyá»‡n & váº­n hÃ nh (Offline/Batch)

#### **Äá»‹nh nghÄ©a Schema NLU**

- **Intents:** `chao_hoi`, `tim_bds`, `hoi_gia`, `dat_lich_xem`, `tu_van_vay`, `ket_thuc`, `smalltalk`, `khong_hieu`.
- **Slots:** nhÆ° pháº§n trÃªn.

#### **Thu tháº­p & GÃ¡n nhÃ£n**

- Nguá»“n: log CSKH, FAQ, dá»¯ liá»‡u public, paraphrase.
- Dá»¥ng cá»¥: Doccano/Label Studio.
- Má»¥c tiÃªu: â‰¥300 cÃ¢u/intent.

#### **Augmentation**

- Paraphrase tiáº¿ng Viá»‡t.
- Thay sá»‘/Ä‘Æ¡n vá»‹/Ä‘á»‹a danh báº±ng template + gazetteer.

#### **Huáº¥n luyá»‡n** (LÃ m sau)

- Intent: fine-tune transformer nhá» (ViBERT/PhoBERT) hoáº·c SVM.
- NER/Slots: BiLSTM-CRF/transformer + post-rule regex.
- LLM guardrail Ä‘á»ƒ phÃ¡t hiá»‡n OOD.

#### **ÄÃ¡nh giÃ¡**

- Intent: Accuracy/F1 macro.
- Slots: F1 entity-level.
- Robustness: lá»—i chÃ­nh táº£, viáº¿t táº¯t.
- Thiáº¿t láº­p confidence threshold báº±ng ROC.

#### **Triá»ƒn khai & GiÃ¡m sÃ¡t**

- ÄÃ³ng gÃ³i model â†’ service (REST/gRPC).
- Caching gazetteer trong RAM.
- A/B test, logging, active learning.

---

### ğŸ§± Cáº¥u trÃºc dá»¯ liá»‡u khuyáº¿n nghá»‹

#### **Gazetteer**

```json
{
  "khu_vuc": ["quáº­n 1", "quáº­n 7", "bÃ¬nh tháº¡nh", "thá»§ Ä‘á»©c", "nhÃ  bÃ¨"],
  "loai_bds": [
    "chung cÆ°",
    "cÄƒn há»™",
    "nhÃ  phá»‘",
    "Ä‘áº¥t ná»n",
    "shophouse"
  ],
  "huong": [
    "Ä‘Ã´ng",
    "tÃ¢y",
    "nam",
    "báº¯c",
    "Ä‘Ã´ng nam",
    "tÃ¢y nam",
    "Ä‘Ã´ng báº¯c",
    "tÃ¢y báº¯c"
  ]
}
```

#### **Entity Schema (JSON Schema)**

```json
{
  "type": "object",
  "properties": {
    "khu_vuc": { "type": "string" },
    "ngan_sach_min": { "type": "number" },
    "ngan_sach_max": { "type": "number" },
    "currency": { "type": "string", "enum": ["VND", "USD"] },
    "loai_bds": { "type": "string" },
    "so_phong": { "type": "integer", "minimum": 0 },
    "dien_tich": { "type": "number", "minimum": 0 },
    "huong_nha": { "type": "string" },
    "thoi_gian": {
      "type": "string",
      "description": "ISO datetime or natural phrase"
    }
  },
  "required": []
}
```

---

### ğŸ§­ Quy táº¯c háº­u kiá»ƒm (Post-rules)

- **NgÃ¢n sÃ¡ch:** náº¿u chá»‰ nÃ³i â€œ3 tá»·â€ â†’ `ngan_sach_max=3e9`.
- **ÄÆ¡n vá»‹ tiá»n:** máº·c Ä‘á»‹nh VND náº¿u khÃ´ng cÃ³.
- **Khu vá»±c:** chuáº©n hoÃ¡ theo danh má»¥c hÃ nh chÃ­nh.
- **Loáº¡i BÄS:** Ä‘á»“ng nghÄ©a "chung cÆ°" ~ "cÄƒn há»™".
- **Thá»i gian:** "cuá»‘i tuáº§n", "chiá»u mai" â†’ parse sang ISO (Asia/Ho_Chi_Minh).

---

### ğŸ§ª VÃ­ dá»¥ Ä‘áº§u vÃ o â†’ Ä‘áº§u ra

**Input:** â€œTÃ´i muá»‘n cÄƒn 2pn á»Ÿ q7 táº§m dÆ°á»›i 3 tá»·â€  
**Output:**

```
intent=tim_bds
slots={loai_bds:"chung cÆ°", so_phong:2, khu_vuc:"quáº­n 7", ngan_sach_max:3000000000, currency:"VND"}
```

**Input:** â€œXem giÃºp giÃ¡ Ä‘áº¥t ná»n bÃ¬nh chÃ¡nh khoáº£ng 1.2 tá»·â€  
**Output:**

```
intent=hoi_gia hoáº·c tim_bds
slots={loai_bds:"Ä‘áº¥t ná»n", khu_vuc:"bÃ¬nh chÃ¡nh", ngan_sach_max:1200000000}
```

**Input:** â€œMai 3 giá» chiá»u ráº£nh, Ä‘áº·t lá»‹ch xem Sunrise Riverside nhÃ©â€  
**Output:**

```
intent=dat_lich_xem
slots={du_an:"Sunrise Riverside", thoi_gian:"YYYY-MM-DDT15:00:00+07:00"}
```

---

### ğŸ›¡ï¸ Xá»­ lÃ½ lá»—i & cÃ¢u mÆ¡ há»“

- Thiáº¿u slot: â€œMÃ¬nh muá»‘n mua nhÃ  áº¡â€ â†’ há»i bá»• sung.
- MÃ¢u thuáº«n: â€œQ7 dÆ°á»›i 2 tá»·, cÄƒn há»™ 3PN, 120mÂ²â€ â†’ gá»£i Ã½ ná»›i Ä‘iá»u kiá»‡n.
- OOD: â€œKá»ƒ chuyá»‡n cÆ°á»i Ä‘iâ€ â†’ chuyá»ƒn sang `smalltalk`.

---

### ğŸ“ KPI & Chá»‰ tiÃªu gá»£i Ã½

- Intent F1 â‰¥ **0.90**.
- Slot F1 â‰¥ **0.85**.
- Latency < **150ms** (CPU) hoáº·c < **50ms** (GPU).
- Coverage alias â‰¥ **98%**.

---

### ğŸ§© Kiáº¿n trÃºc nháº¹ (plug-and-play)

- **Service:** `/parse` (FastAPI) â†’ tráº£ `{intent, slots, confidence}`.
- **Models:** `intent.bin`, `slots.bin`, `rules.yaml`.
- **Config:** `thresholds.yaml`, `normalizers.py`, `alias.json`.
- **CI:** Unit test normalizer + script eval F1 tá»± Ä‘á»™ng.
