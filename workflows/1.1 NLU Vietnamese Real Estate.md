## ğŸ§  Workflow Chá»©c nÄƒng 1.1 â€“ NLU

### ğŸ¯ Má»¥c tiÃªu & I/O

**Má»¥c tiÃªu:** Nháº­n cÃ¢u ngÆ°á»i dÃ¹ng â†’ xÃ¡c Ä‘á»‹nh Intent + trÃ­ch xuáº¥t thÃ´ng tin
**Input:** CÃ¢u ngÆ°á»i dÃ¹ng (tiáº¿ng Viá»‡t, cÃ³ thá»ƒ láº«n Anh/viáº¿t táº¯t/emoji).  
**Output:** `{intent, payload, language, normalized_text, confidence}`

---

### ğŸš¦ Luá»“ng runtime (Inference) â€“ tá»«ng bÆ°á»›c

#### **1. Preprocess**

- Detect language (vi, en, vi+en), chuáº©n hoÃ¡ Unicode (NFC).
- Lower-case cÃ³ kiá»ƒm soÃ¡t, tÃ¡ch sá»‘/Ä‘Æ¡n vá»‹ ("3 tá»·", "2.5 ty", "3000usd").
- Bá» emoji.
- Chuáº©n hoÃ¡ chÃ­nh táº£ thÆ°á»ng gáº·p ("q7" â†’ "quáº­n 7", "hn" â†’ "hÃ  ná»™i").

#### **2. Tokenizer & Feature**

- Tokenize theo subword (PhoBERT/ViBERT).
- ThÃªm Ä‘áº·c trÆ°ng regex/gazetteer (quáº­n/huyá»‡n, loáº¡i BÄS, Ä‘Æ¡n vá»‹ tiá»n).

#### **3. Intent Classification**

- MÃ´ hÃ¬nh phÃ¢n lá»›p intent.
- Top-k intents + xÃ¡c suáº¥t.  
  **5 Intent chÃ­nh:**
  1. `search_apartment` - TÃ¬m kiáº¿m cÄƒn há»™
  2. `show_details` - Hiá»ƒn thá»‹ chi tiáº¿t
  3. `book_appointment` - Äáº·t lá»‹ch háº¹n
  4. `ask_question` - CÃ¢u há»i chung
  5. `general_conversation` - TrÃ² chuyá»‡n

#### **4. Payload Extraction (TrÃ­ch xuáº¥t thÃ´ng tin)**

**Payload** = thÃ´ng tin cá»¥ thá»ƒ tá»« cÃ¢u ngÆ°á»i dÃ¹ng (cÃ²n gá»i lÃ  **slots** hoáº·c **entities**)

**CÃ¡c Payload theo tá»«ng Intent:**

- **search_apartment** (TÃ¬m kiáº¿m):
  - `so_phong_ngu`: int (Sá»‘ phÃ²ng ngá»§)
  - `gia_ban`: dict {min, max} (GiÃ¡ bÃ¡n)
  - `dien_tich`: float (Diá»‡n tÃ­ch mÂ²)
  - `huong`: str (HÆ°á»›ng nhÃ : ÄÃ´ng, TÃ¢y, Nam, Báº¯c...)
  - `view`: str (View: biá»ƒn, cÃ´ng viÃªn...)
  - `noi_that`: str (Ná»™i tháº¥t: Ä‘áº§y Ä‘á»§, cÆ¡ báº£n, trá»‘ng...)
- **show_details** (Xem chi tiáº¿t):
  - `ma_can_ho`: str (MÃ£ cÄƒn há»™ cáº§n xem)
  - `toa`: str (TÃ²a nhÃ )
- **book_appointment** (Äáº·t lá»‹ch):
  - `ma_can_ho`: str (MÃ£ cÄƒn há»™)
  - `thoi_gian`: datetime (Thá»i gian háº¹n)
  - `ten_khach`: str (TÃªn khÃ¡ch hÃ ng)
  - `sdt`: str (Sá»‘ Ä‘iá»‡n thoáº¡i)
- **ask_question** (Há»i Ä‘Ã¡p):
  - `chu_de`: str (Chá»§ Ä‘á»: giÃ¡, diá»‡n tÃ­ch, tiá»‡n Ã­ch...)
  - `ma_can_ho`: str? (MÃ£ cÄƒn náº¿u há»i vá» cÄƒn cá»¥ thá»ƒ)
- **general_conversation** (TrÃ² chuyá»‡n):
  - KhÃ´ng cáº§n payload cá»¥ thá»ƒ

#### **5. Normalization (Chuáº©n hÃ³a dá»¯ liá»‡u)**

- `gia_ban`: "dÆ°á»›i 3 tá»·" â†’ `{min: null, max: 3000000000, currency: "VND"}`
- `gia_ban`: "tá»« 2 - 3 tá»·" â†’ `{min: 2000000000, max: 3000000000, currency: "VND"}`
- `dien_tich`: "70m2" â†’ 70.0
- `huong`: chuáº©n hoÃ¡ vá» `{ÄÃ´ng, TÃ¢y, Nam, Báº¯c, ÄÃ´ng Nam, TÃ¢y Nam, ÄÃ´ng Báº¯c, TÃ¢y Báº¯c}`
- `thoi_gian`: "mai 3 giá» chiá»u" â†’ ISO datetime (Asia/Ho_Chi_Minh)
- `sdt`: "0912345678" â†’ "+84912345678"

#### **6. Context Merge (Káº¿ thá»«a ngá»¯ cáº£nh)**

- LÆ°u trá»¯ **5 cáº·p há»™i thoáº¡i gáº§n nháº¥t**
- Tá»± Ä‘á»™ng káº¿t há»£p payload tá»« cÃ¢u trÆ°á»›c náº¿u thiáº¿u
- **VÃ­ dá»¥:**
  - CÃ¢u 1: "TÃ¬m cÄƒn 2 phÃ²ng ngá»§ hÆ°á»›ng ÄÃ´ng" â†’ `{so_phong_ngu: 2, huong: "ÄÃ´ng"}`
  - CÃ¢u 2: "GiÃ¡ dÆ°á»›i 3 tá»·" â†’ Káº¿ thá»«a + bá»• sung â†’ `{so_phong_ngu: 2, huong: "ÄÃ´ng", gia_ban: {max: 3e9}}`

#### **7. Output Contract**

```json
{
  "intent": "search_apartment",
  "confidence": 0.95,
  "payload": {
    "so_phong_ngu": 2,
    "gia_ban": {
      "min": null,
      "max": 3000000000,
      "currency": "VND"
    },
    "huong": "ÄÃ´ng",
    "view": null,
    "dien_tich": null,
    "noi_that": null
  },
  "language": "vi",
  "normalized_text": "tÃ¬m cÄƒn 2 phÃ²ng ngá»§ hÆ°á»›ng Ä‘Ã´ng dÆ°á»›i 3 tá»·"
}
```

---

### ğŸ§­ Quy táº¯c háº­u kiá»ƒm (Post-rules)

- **GiÃ¡ bÃ¡n:**
  - Chá»‰ nÃ³i "3 tá»·" â†’ `{min: null, max: 3e9}`
  - "Tá»« 2 tá»·" â†’ `{min: 2e9, max: null}`
  - "Khoáº£ng 3 tá»·" â†’ `{min: 2.7e9, max: 3.3e9}` (Â±10%)
- **ÄÆ¡n vá»‹ tiá»n:** máº·c Ä‘á»‹nh VND náº¿u khÃ´ng cÃ³
- **HÆ°á»›ng:** chuáº©n hoÃ¡ "Ä‘" â†’ "ÄÃ´ng", "t" â†’ "TÃ¢y", "dn" â†’ "ÄÃ´ng Nam"...
- **Sá»‘ phÃ²ng:** "2pn", "2 phÃ²ng", "2PN" â†’ 2
- **Thá»i gian:** "cuá»‘i tuáº§n", "chiá»u mai" â†’ parse sang ISO (Asia/Ho_Chi_Minh)
- **Ná»™i tháº¥t:** "full", "Ä‘áº§y Ä‘á»§", "hoÃ n thiá»‡n" â†’ "Ä‘áº§y Ä‘á»§"

---

### ğŸ§ª VÃ­ dá»¥ Ä‘áº§u vÃ o â†’ Ä‘áº§u ra

#### **VÃ­ dá»¥ 1: TÃ¬m kiáº¿m cÄƒn há»™**

**Input:** "TÃ´i muá»‘n tÃ¬m cÄƒn 2 phÃ²ng ngá»§ hÆ°á»›ng ÄÃ´ng dÆ°á»›i 3 tá»·"

```json
{
  "intent": "search_apartment",
  "confidence": 0.96,
  "payload": {
    "so_phong_ngu": 2,
    "huong": "ÄÃ´ng",
    "gia_ban": {
      "min": null,
      "max": 3000000000,
      "currency": "VND"
    }
  },
  "language": "vi",
  "normalized_text": "tÃ´i muá»‘n tÃ¬m cÄƒn 2 phÃ²ng ngá»§ hÆ°á»›ng Ä‘Ã´ng dÆ°á»›i 3 tá»·"
}
```

#### **VÃ­ dá»¥ 2: Xem chi tiáº¿t**

**Input:** "Cho tÃ´i xem chi tiáº¿t cÄƒn A1205 tÃ²a S1"

```json
{
  "intent": "show_details",
  "confidence": 0.93,
  "payload": {
    "ma_can_ho": "A1205",
    "toa": "S1"
  },
  "language": "vi",
  "normalized_text": "cho tÃ´i xem chi tiáº¿t cÄƒn a1205 tÃ²a s1"
}
```

#### **VÃ­ dá»¥ 3: Äáº·t lá»‹ch háº¹n**

**Input:** "Äáº·t lá»‹ch xem cÄƒn A1205 vÃ o mai 3 giá» chiá»u, tÃ´i tÃªn Minh, sdt 0912345678"

```json
{
  "intent": "book_appointment",
  "confidence": 0.98,
  "payload": {
    "ma_can_ho": "A1205",
    "thoi_gian": "2025-11-14T15:00:00+07:00",
    "ten_khach": "Minh",
    "sdt": "+84912345678"
  },
  "language": "vi",
  "normalized_text": "Ä‘áº·t lá»‹ch xem cÄƒn a1205 vÃ o mai 3 giá» chiá»u tÃ´i tÃªn minh sdt 0912345678"
}
```

#### **VÃ­ dá»¥ 4: Há»i thÃ´ng tin**

**Input:** "CÄƒn A1205 giÃ¡ bao nhiÃªu váº­y?"

```json
{
  "intent": "ask_question",
  "confidence": 0.91,
  "payload": {
    "chu_de": "gia_ban",
    "ma_can_ho": "A1205"
  },
  "language": "vi",
  "normalized_text": "cÄƒn a1205 giÃ¡ bao nhiÃªu váº­y"
}
```

#### **VÃ­ dá»¥ 5: TrÃ² chuyá»‡n**

**Input:** "ChÃ o báº¡n, hÃ´m nay tháº¿ nÃ o?"

```json
{
  "intent": "general_conversation",
  "confidence": 0.89,
  "payload": {},
  "language": "vi",
  "normalized_text": "chÃ o báº¡n hÃ´m nay tháº¿ nÃ o"
}
```

---

### ğŸ›¡ï¸ Xá»­ lÃ½ lá»—i & cÃ¢u mÆ¡ há»“

- **Thiáº¿u payload:** "MÃ¬nh muá»‘n tÃ¬m cÄƒn há»™ áº¡" â†’ há»i bá»• sung thÃ´ng tin cá»¥ thá»ƒ
  - Bot: "Anh/chá»‹ muá»‘n tÃ¬m cÄƒn há»™ bao nhiÃªu phÃ²ng ngá»§ vÃ  ngÃ¢n sÃ¡ch bao nhiÃªu áº¡?"
- **MÃ¢u thuáº«n:** "CÄƒn 3 phÃ²ng ngá»§ 120mÂ² giÃ¡ dÆ°á»›i 2 tá»·" â†’ khÃ´ng kháº£ thi
  - Bot: "Em tÃ¬m tháº¥y ráº¥t Ã­t cÄƒn phÃ¹ há»£p. Anh/chá»‹ cÃ³ thá»ƒ tÄƒng ngÃ¢n sÃ¡ch hoáº·c giáº£m yÃªu cáº§u khÃ´ng áº¡?"
- **Intent khÃ´ng rÃµ:** Confidence < 0.7 â†’ xÃ¡c nháº­n láº¡i
  - Bot: "Anh/chá»‹ muá»‘n: 1) TÃ¬m kiáº¿m cÄƒn há»™, 2) Äáº·t lá»‹ch xem nhÃ , hay 3) Há»i thÃ´ng tin?"
- **Out of Domain:** "Ká»ƒ chuyá»‡n cÆ°á»i Ä‘i" â†’ `general_conversation` hoáº·c tá»« chá»‘i lá»‹ch sá»±
  - Bot: "Em lÃ  trá»£ lÃ½ tÆ° váº¥n báº¥t Ä‘á»™ng sáº£n, em cÃ³ thá»ƒ giÃºp anh/chá»‹ tÃ¬m cÄƒn há»™ áº¡!"

---
