## ğŸ§  Workflow Chá»©c nÄƒng 1.1 â€“ NLU

### ğŸ¯ Má»¥c tiÃªu & I/O

**Má»¥c tiÃªu:** Nháº­n cÃ¢u ngÆ°á»i dÃ¹ng â†’ xÃ¡c Ä‘á»‹nh Intent
**Input:** CÃ¢u ngÆ°á»i dÃ¹ng (tiáº¿ng Viá»‡t, cÃ³ thá»ƒ láº«n Anh/viáº¿t táº¯t/emoji).  
**Output:** `{intent, slots, language, normalized_text, confidence, errors?}`

---

### ğŸš¦ Luá»“ng runtime (Inference) â€“ tá»«ng bÆ°á»›c

#### **1. Preprocess**

- Detect language (vi, en, vi+en), chuáº©n hoÃ¡ Unicode (NFC).
- Lower-case cÃ³ kiá»ƒm soÃ¡t, tÃ¡ch sá»‘/Ä‘Æ¡n vá»‹ ("3 tá»·", "2.5 ty", "3000usd").
- Bá» emoji.
- Chuáº©n hoÃ¡ chÃ­nh táº£ thÆ°á»ng gáº·p ("q7" â†’ "quáº­n 7", "hn" â†’ "hÃ  ná»™i").

#### **2. Tokenizer & Feature**

- Tokenize theo subword (PhoBERT/ViBERT).
- ThÃªm Ä‘áº·c trÆ°ng regex/gazetteer (quáº­n/huyá»‡n, loáº¡i BÄS, Ä‘Æ¡n vá»‹ tiá»n).

#### **3. Intent Classification**

- MÃ´ hÃ¬nh phÃ¢n lá»›p intent.
- Top-k intents + xÃ¡c suáº¥t.  
  **VÃ­ dá»¥:** `tim_bds`, `dat_lich_xem`, `general`, `khong_hieu`, `ket_thuc`.

#### **4. Payload**

- **Payload gá»£i Ã½ cho BÄS:**
  - `loai_bds`, `khu_vuc`, `ngan_sach`, `so_phong`, `dien_tich`, `huong_nha`, `du_an`, `thoi_gian`, `phuong_thuc`.

#### **5. Normalization**

- `ngan_sach`: â€œ<3 tá»·â€ â†’ `{max: 3e9, currency: VND}`.
- `khu_vuc`: map alias â†’ mÃ£ hÃ nh chÃ­nh chuáº©n.
- `dien_tich`: â€œ70m2â€ â†’ 70.
- `huong_nha`: chuáº©n hoÃ¡ vá» bá»™ `{ÄÃ´ng, TÃ¢y, Nam, Báº¯c, ÄN, TN, ÄB, TB}`.

#### **7. Context Merge**

- Há»£p nháº¥t vá»›i bá»™ nhá»› ngáº¯n háº¡n (vÃ­ dá»¥: thá»«a káº¿ `khu_vuc` tá»« cÃ¢u trÆ°á»›c).

#### **8. Output Contract**

```json
{
  "intent": "tim_bds",
  "payload": {
    "khu_vuc": "quáº­n 7",
    "ngan_sach_max": 3000000000,
    "loai_bds": "chung cÆ°",
    "so_phong": 2,
    "dien_tich": 56m
  },
  "language": "vi",
  "normalized_text": "tÃ¬m chung cÆ° 2 phÃ²ng ngá»§ á»Ÿ quáº­n 7 dÆ°á»›i 3 tá»·",
}
```

---

### ğŸ§­ Quy táº¯c háº­u kiá»ƒm (Post-rules)

- **NgÃ¢n sÃ¡ch:** náº¿u chá»‰ nÃ³i â€œ3 tá»·â€ â†’ `ngan_sach_max=3e9`.
- **ÄÆ¡n vá»‹ tiá»n:** máº·c Ä‘á»‹nh VND náº¿u khÃ´ng cÃ³.
- **Khu vá»±c:** chuáº©n hoÃ¡ theo danh má»¥c hÃ nh chÃ­nh.
- **Loáº¡i BÄS:** Ä‘á»“ng nghÄ©a "chung cÆ°" ~ "cÄƒn há»™".
- **Thá»i gian:** "cuá»‘i tuáº§n", "chiá»u mai" â†’ parse sang ISO (Asia/Ho_Chi_Minh).

---

### ğŸ§ª VÃ­ dá»¥ Ä‘áº§u vÃ o â†’ Ä‘áº§u ra

**Input:** â€œTÃ´i muá»‘n cÄƒn 2pn á»Ÿ q7 táº§m dÆ°á»›i 3 tá»·â€  
**Output:**

```
intent=tim_bds
payload={loai_bds:"chung cÆ°", so_phong:2, khu_vuc:"quáº­n 7", ngan_sach_max:3000000000, currency:"VND"}
```

**Input:** â€œXem giÃºp giÃ¡ Ä‘áº¥t ná»n bÃ¬nh chÃ¡nh khoáº£ng 1.2 tá»·â€  
**Output:**

```
intent=hoi_gia hoáº·c tim_bds
slots={loai_bds:"Ä‘áº¥t ná»n", khu_vuc:"bÃ¬nh chÃ¡nh", ngan_sach_max:1200000000}
```

**Input:** â€œMai 3 giá» chiá»u ráº£nh, Ä‘áº·t lá»‹ch xem Sunrise Riverside nhÃ©â€  
**Output:**

```
intent=dat_lich_xem
slots={du_an:"Sunrise Riverside", thoi_gian:"YYYY-MM-DDT15:00:00+07:00"}
```

---

### ğŸ›¡ï¸ Xá»­ lÃ½ lá»—i & cÃ¢u mÆ¡ há»“

- Thiáº¿u slot: â€œMÃ¬nh muá»‘n mua nhÃ  áº¡â€ â†’ há»i bá»• sung.
- MÃ¢u thuáº«n: â€œQ7 dÆ°á»›i 2 tá»·, cÄƒn há»™ 3PN, 120mÂ²â€ â†’ gá»£i Ã½ ná»›i Ä‘iá»u kiá»‡n.
- OOD: â€œKá»ƒ chuyá»‡n cÆ°á»i Ä‘iâ€ â†’ chuyá»ƒn sang `smalltalk`.

---
